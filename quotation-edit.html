<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Edit Quotation</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  margin: 16px;
  background: #f5f5f5;
}

h1 {
  margin-bottom: 12px;
}

.card {
  background: #fff;
  padding: 14px;
  border-radius: 6px;
  margin-bottom: 12px;
}

label {
  font-size: 14px;
  font-weight: bold;
  display: block;
  margin-bottom: 4px;
}

input {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  margin-bottom: 8px;
}

.item-row {
  display: grid;
  grid-template-columns: 1fr 80px 100px 40px;
  gap: 6px;
  margin-bottom: 6px;
}

.item-row input {
  margin-bottom: 0;
}

button {
  padding: 10px;
  font-size: 14px;
  cursor: pointer;
}

.btn-add {
  background: #e0e0e0;
  border: none;
}

.btn-save {
  background: #2e7d32;
  color: #fff;
  border: none;
  width: 100%;
}

.btn-cancel {
  background: #9e9e9e;
  color: #fff;
  border: none;
  width: 100%;
  margin-top: 6px;
}

.btn-delete {
  background: #d32f2f;
  color: #fff;
  border: none;
}

.total {
  text-align: right;
  font-size: 16px;
  font-weight: bold;
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>Edit Quotation</h1>

<div class="card">
  <label>Customer</label>
  <input id="customer" placeholder="Customer name" />
</div>

<div class="card">
  <label>Items</label>
  <div id="items"></div>

  <button class="btn-add" onclick="addItem()">+ Add Item</button>

  <div class="total">
    Total: RM <span id="total">0.00</span>
  </div>
</div>

<button class="btn-save" onclick="save()">Save Changes</button>
<button class="btn-cancel" onclick="cancel()">Cancel</button>

<script>
function q(name) {
  return new URLSearchParams(location.search).get(name);
}

const id = q("id");
let quotationStatus = "";

function addItem(desc = "", qty = 1, price = 0) {
  const div = document.createElement("div");
  div.className = "item-row";
  div.innerHTML = `
    <input placeholder="Description" value="${desc}">
    <input type="number" min="1" value="${qty}">
    <input type="number" step="0.01" min="0" value="${price}">
    <button class="btn-delete" onclick="this.parentNode.remove(); calc()">âœ•</button>
  `;
  document.getElementById("items").appendChild(div);
}

function calc() {
  let total = 0;
  document.querySelectorAll(".item-row").forEach(row => {
    const qty = Number(row.children[1].value || 0);
    const price = Number(row.children[2].value || 0);
    total += qty * price;
  });
  document.getElementById("total").textContent = total.toFixed(2);
}

function cancel() {
  location.href = `/quotation-view.html?id=${id}`;
}

async function save() {
  if (quotationStatus !== "OPEN") {
    alert("Only OPEN quotations can be edited");
    return;
  }

  const items = [];
  document.querySelectorAll(".item-row").forEach(row => {
    items.push({
      description: row.children[0].value,
      qty: Number(row.children[1].value),
      price: Number(row.children[2].value)
    });
  });

  const res = await fetch("/api/quotation-edit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({
      id,
      customer: document.getElementById("customer").value,
      items
    })
  });

  if (!res.ok) {
    alert("Failed to save quotation");
    return;
  }

  location.href = `/quotation-view.html?id=${id}`;
}

fetch(`/api/quotation-view?id=${id}`, { credentials: "include" })
.then(res => {
  if (res.status === 401) {
    location.replace("/login.html");
    throw new Error();
  }
  return res.json();
})
.then(data => {
  const q = data.quotation;
  quotationStatus = q.status;

  document.getElementById("customer").value = q.customer;

  if (q.status !== "OPEN") {
    alert("This quotation is not editable");
    location.replace(`/quotation-view.html?id=${id}`);
    return;
  }

  data.items.forEach(i => addItem(i.description, i.qty, i.price));
  calc();
})
.catch(() => {});
</script>

</body>
</html>
