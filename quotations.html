<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quotations</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 16px;
  background: #f5f5f5;
}

h1 {
  margin-top: 0;
}

.filter-box {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
}

.filter-box label {
  font-size: 13px;
  font-weight: bold;
  display: block;
  margin-top: 6px;
}

.filter-box input,
.filter-box select {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  margin-top: 4px;
}

.list {
  background: #fff;
  border-radius: 6px;
  overflow: hidden;
}

.item {
  border-bottom: 1px solid #eee;
  padding: 12px;
  cursor: pointer;
}

.item:last-child {
  border-bottom: none;
}

.item .row {
  font-size: 14px;
  margin-bottom: 4px;
}

.status {
  font-weight: bold;
}

.OPEN { color: #1c7ed6; }
.ACCEPTED { color: #2f9e44; }
.VOID { color: #c92a2a; }

/* ===== 打印时隐藏过滤 ===== */
@media print {
  .filter-box { display: none; }
}
</style>
</head>

<body>

<h1>Quotations</h1>

<!-- ===== Filters ===== -->
<div class="filter-box">
  <label>Status</label>
  <select id="filterStatus" onchange="applyFilter()">
    <option value="">ALL</option>
    <option value="OPEN">OPEN</option>
    <option value="ACCEPTED">ACCEPTED</option>
    <option value="VOID">VOID</option>
  </select>

  <label>Quotation No</label>
  <input id="filterQuoteNo" placeholder="Search quotation no" oninput="applyFilter()">

  <label>Customer</label>
  <input id="filterCustomer" placeholder="Search customer" oninput="applyFilter()">
</div>

<!-- ===== Quotation List ===== -->
<div class="list" id="list"></div>

<script>
let quotations = [];

fetch("/api/quotations", { credentials: "include" })
.then(res => {
  if (res.status === 401) {
    location.replace("/login.html");
    throw new Error("Unauthorized");
  }
  return res.json();
})
.then(data => {
  quotations = data;
  render(quotations);
})
.catch(err => alert(err.message));

function applyFilter() {
  const status = document.getElementById("filterStatus").value;
  const quoteNo = document.getElementById("filterQuoteNo").value.toLowerCase();
  const customer = document.getElementById("filterCustomer").value.toLowerCase();

  const filtered = quotations.filter(q => {
    if (status && q.status !== status) return false;
    if (quoteNo && !q.quotation_no.toLowerCase().includes(quoteNo)) return false;
    if (customer && !q.customer.toLowerCase().includes(customer)) return false;
    return true;
  });

  render(filtered);
}

function render(list) {
  const container = document.getElementById("list");
  container.innerHTML = "";

  if (!list.length) {
    container.innerHTML = "<div class='item'>No quotations found</div>";
    return;
  }

  list.forEach(q => {
    const div = document.createElement("div");
    div.className = "item";
    div.onclick = () => {
      location.href = `/quotation-view.html?id=${q.id}`;
    };

    div.innerHTML = `
      <div class="row"><strong>${q.quotation_no}</strong></div>
      <div class="row">Customer: ${q.customer}</div>
      <div class="row">Total: RM ${q.amount.toFixed(2)}</div>
      <div class="row status ${q.status}">${q.status}</div>
    `;
    container.appendChild(div);
  });
}
</script>

</body>
</html>
